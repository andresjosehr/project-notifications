<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Sistema Freelance</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-brand">
                    <h1>üë§ Mi Perfil</h1>
                    <p>Sistema de Notificaciones Freelance v2.0 - Gesti√≥n de Perfil Personal</p>
                </div>
                <div class="header-nav">
                    <a href="users.html" class="nav-link">üë• Usuarios</a>
                    <a href="projects.html" class="nav-link">üìã Proyectos</a>
                    <a href="control.html" class="nav-link">‚öôÔ∏è Control Panel</a>
                    <a href="profile.html" class="nav-link active">üë§ Mi Perfil</a>
                    <div class="header-user">
                        <span id="currentUser">Cargando...</span>
                        <button class="btn btn-secondary btn-small" onclick="logout()">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error" id="errorAlert"></div>

            <!-- Informaci√≥n B√°sica -->
            <div class="section">
                <h2 class="section-title">üìã Informaci√≥n B√°sica</h2>
                <div class="form-container">
                    <form id="basicInfoForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email del Sistema</label>
                                <input type="email" id="email" name="email" readonly>
                                <small>El email del sistema no se puede cambiar</small>
                            </div>
                            <div class="form-group">
                                <label for="role">Rol</label>
                                <input type="text" id="role" name="role" readonly>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="telegramUser">Usuario de Telegram *</label>
                            <input type="text" id="telegramUser" name="telegram_user" required 
                                   placeholder="Ej: @usuario_telegram">
                            <small>Tu usuario de Telegram para recibir notificaciones</small>
                        </div>

                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">
                                üíæ Guardar Informaci√≥n B√°sica
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Credenciales de Workana -->
            <div class="section">
                <h2 class="section-title">üîë Credenciales de Workana</h2>
                <div class="form-container">
                    <form id="workanaCredentialsForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="workanaEmail">Email de Workana *</label>
                                <input type="email" id="workanaEmail" name="workana_email" required>
                                <small>Email que usas para iniciar sesi√≥n en Workana</small>
                            </div>
                            <div class="form-group">
                                <label for="workanaPassword">Contrase√±a de Workana *</label>
                                <input type="password" id="workanaPassword" name="workana_password" required>
                                <small>Contrase√±a de tu cuenta de Workana</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">
                                üîë Actualizar Credenciales
                            </button>
                            <button type="button" class="btn btn-info" onclick="testWorkanaConnection()">
                                üß™ Probar Conexi√≥n
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Directrices de Propuesta -->
            <div class="section">
                <h2 class="section-title">üìù Directrices de Propuesta</h2>
                <div class="form-container">
                    <form id="proposalDirectivesForm">
                        <div class="form-group">
                            <label for="proposalDirectives">Directrices de Propuesta *</label>
                            <textarea id="proposalDirectives" name="proposal_directives" required rows="8"
                                      placeholder="Ingrese las directrices para generar propuestas autom√°ticas..."></textarea>
                            <small>Estas directrices guiar√°n la generaci√≥n autom√°tica de propuestas para proyectos</small>
                        </div>

                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">
                                üìù Guardar Directrices
                            </button>
                            <button type="button" class="btn btn-info" onclick="previewProposal()">
                                üëÅÔ∏è Vista Previa
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Perfil Profesional -->
            <div class="section">
                <h2 class="section-title">üë®‚Äçüíº Perfil Profesional</h2>
                <div class="form-container">
                    <form id="professionalProfileForm">
                        <div class="form-group">
                            <label for="professionalProfile">Perfil Profesional *</label>
                            <textarea id="professionalProfile" name="professional_profile" required rows="10"
                                      placeholder="Ingrese su perfil profesional completo..."></textarea>
                            <small>Descripci√≥n de tu experiencia, habilidades y especialidades profesionales</small>
                        </div>

                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">
                                üë®‚Äçüíº Guardar Perfil
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Cambiar Contrase√±a -->
            <div class="section">
                <h2 class="section-title">üîí Cambiar Contrase√±a del Sistema</h2>
                <div class="form-container">
                    <form id="changePasswordForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="currentPassword">Contrase√±a Actual *</label>
                                <input type="password" id="currentPassword" name="current_password" required>
                            </div>
                            <div class="form-group">
                                <label for="newPassword">Nueva Contrase√±a *</label>
                                <input type="password" id="newPassword" name="new_password" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword">Confirmar Nueva Contrase√±a *</label>
                            <input type="password" id="confirmPassword" name="confirm_password" required>
                        </div>

                        <div class="form-row">
                            <button type="submit" class="btn btn-warning">
                                üîí Cambiar Contrase√±a
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Vista Previa de Propuesta -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üëÅÔ∏è Vista Previa de Propuesta</h2>
                <span class="close" onclick="closePreviewModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <div class="loading">Generando vista previa...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/components.js"></script>
    <script>
        let currentUserData = null;

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!Utils.isAuthenticated()) {
                Utils.checkAuthRedirect();
                return;
            }

            // Display current user info
            const userInfo = Utils.getUserInfo();
            if (userInfo) {
                document.getElementById('currentUser').textContent = userInfo.email;
            }

            loadUserProfile();
        });

        // Load user profile data
        async function loadUserProfile() {
            try {
                const userInfo = Utils.getUserInfo();
                if (!userInfo) {
                    throw new Error('No se pudo obtener informaci√≥n del usuario');
                }

                const result = await api.getUserById(userInfo.id);
                
                if (result.success) {
                    currentUserData = result.data;
                    populateProfileForm(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showAlert('error', 'Error cargando perfil: ' + error.message);
            }
        }

        // Populate form with user data
        function populateProfileForm(userData) {
            // Basic info
            document.getElementById('email').value = userData.email || '';
            document.getElementById('role').value = userData.role || '';
            document.getElementById('telegramUser').value = userData.telegramUser || '';

            // Find Workana credentials
            const workanaCredential = userData.credentials ? 
                userData.credentials.find(cred => cred.platform === 'workana') : null;
            
            if (workanaCredential) {
                document.getElementById('workanaEmail').value = workanaCredential.email || '';
                // Don't populate password for security
            }

            // Proposal directives and professional profile
            document.getElementById('proposalDirectives').value = userData.proposalDirectives || '';
            document.getElementById('professionalProfile').value = userData.professionalProfile || '';
        }

        // Basic info form submission
        document.getElementById('basicInfoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const updateData = {
                telegram_user: formData.get('telegram_user')
            };
            
            try {
                const userInfo = Utils.getUserInfo();
                const result = await api.updateUser(userInfo.id, updateData);
                
                if (result.success) {
                    showAlert('success', 'Informaci√≥n b√°sica actualizada exitosamente');
                    loadUserProfile(); // Refresh data
                } else {
                    showAlert('error', result.error);
                }
            } catch (error) {
                showAlert('error', 'Error actualizando informaci√≥n: ' + error.message);
            }
        });

        // Workana credentials form submission
        document.getElementById('workanaCredentialsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const updateData = {
                workana_email: formData.get('workana_email'),
                workana_password: formData.get('workana_password')
            };
            
            try {
                const userInfo = Utils.getUserInfo();
                const result = await api.updateUser(userInfo.id, updateData);
                
                if (result.success) {
                    showAlert('success', 'Credenciales de Workana actualizadas exitosamente');
                    // Clear password field for security
                    document.getElementById('workanaPassword').value = '';
                    loadUserProfile(); // Refresh data
                } else {
                    showAlert('error', result.error);
                }
            } catch (error) {
                showAlert('error', 'Error actualizando credenciales: ' + error.message);
            }
        });

        // Proposal directives form submission
        document.getElementById('proposalDirectivesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const updateData = {
                proposal_directives: formData.get('proposal_directives')
            };
            
            try {
                const userInfo = Utils.getUserInfo();
                const result = await api.updateUser(userInfo.id, updateData);
                
                if (result.success) {
                    showAlert('success', 'Directrices de propuesta actualizadas exitosamente');
                    loadUserProfile(); // Refresh data
                } else {
                    showAlert('error', result.error);
                }
            } catch (error) {
                showAlert('error', 'Error actualizando directrices: ' + error.message);
            }
        });

        // Professional profile form submission
        document.getElementById('professionalProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const updateData = {
                professional_profile: formData.get('professional_profile')
            };
            
            try {
                const userInfo = Utils.getUserInfo();
                const result = await api.updateUser(userInfo.id, updateData);
                
                if (result.success) {
                    showAlert('success', 'Perfil profesional actualizado exitosamente');
                    loadUserProfile(); // Refresh data
                } else {
                    showAlert('error', result.error);
                }
            } catch (error) {
                showAlert('error', 'Error actualizando perfil: ' + error.message);
            }
        });

        // Change password form submission
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');
            
            if (newPassword !== confirmPassword) {
                showAlert('error', 'Las contrase√±as no coinciden');
                return;
            }
            
            const updateData = {
                current_password: formData.get('current_password'),
                password: newPassword
            };
            
            try {
                const userInfo = Utils.getUserInfo();
                const result = await api.updateUser(userInfo.id, updateData);
                
                if (result.success) {
                    showAlert('success', 'Contrase√±a cambiada exitosamente');
                    this.reset(); // Clear form
                } else {
                    showAlert('error', result.error);
                }
            } catch (error) {
                showAlert('error', 'Error cambiando contrase√±a: ' + error.message);
            }
        });

        // Test Workana connection
        async function testWorkanaConnection() {
            const email = document.getElementById('workanaEmail').value;
            const password = document.getElementById('workanaPassword').value;
            
            if (!email || !password) {
                showAlert('error', 'Por favor ingrese email y contrase√±a de Workana');
                return;
            }
            
            try {
                showAlert('info', 'Probando conexi√≥n con Workana...');
                const result = await api.workanaLogin({ username: email, password: password });
                
                if (result.success) {
                    showAlert('success', 'Conexi√≥n exitosa con Workana');
                } else {
                    showAlert('error', 'Error de conexi√≥n: ' + result.error);
                }
            } catch (error) {
                showAlert('error', 'Error probando conexi√≥n: ' + error.message);
            }
        }

        // Preview proposal
        async function previewProposal() {
            const directives = document.getElementById('proposalDirectives').value;
            const profile = document.getElementById('professionalProfile').value;
            
            if (!directives || !profile) {
                showAlert('error', 'Por favor complete las directrices y el perfil profesional');
                return;
            }
            
            // Show modal with preview
            document.getElementById('previewModal').style.display = 'block';
            document.getElementById('previewContent').innerHTML = `
                <h3>üìù Directrices de Propuesta:</h3>
                <div class="preview-section">${directives.replace(/\n/g, '<br>')}</div>
                
                <h3>üë®‚Äçüíº Perfil Profesional:</h3>
                <div class="preview-section">${profile.replace(/\n/g, '<br>')}</div>
                
                <div class="alert alert-info">
                    <strong>Nota:</strong> Esta es una vista previa de c√≥mo se ver√°n tus directrices y perfil. 
                    Para ver una propuesta real generada, necesitar√≠as un proyecto espec√≠fico.
                </div>
            `;
        }

        // Close preview modal
        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
        }

        // Utility functions
        function showAlert(type, message) {
            const alertElement = document.getElementById(type === 'success' ? 'successAlert' : 'errorAlert');
            alertElement.textContent = message;
            alertElement.style.display = 'block';
            
            // Hide other alert
            const otherAlert = document.getElementById(type === 'success' ? 'errorAlert' : 'successAlert');
            otherAlert.style.display = 'none';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }

        // Logout function
        function logout() {
            if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                Utils.logout();
            }
        }

        // Modal controls
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('previewModal');
            if (event.target === modal) {
                closePreviewModal();
            }
        });
    </script>
</body>
</html>