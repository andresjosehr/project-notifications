<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Proyectos - Sistema Freelance</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-nav">
                <a href="users.html" class="nav-link">üë• Usuarios</a>
                <a href="projects.html" class="nav-link active">üìã Proyectos</a>
                <a href="control.html" class="nav-link">‚öôÔ∏è Control Panel</a>
                <div class="header-user">
                    <span id="currentUser">Cargando...</span>
                    <button class="btn btn-secondary btn-small" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
            <h1>üìã Dashboard de Proyectos</h1>
            <p>Sistema de Notificaciones Freelance v2.0 - Gesti√≥n de Proyectos</p>
        </div>

        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="stat-number" id="totalProjects">-</div>
                <div class="stat-label">Total Proyectos</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="workanaProjects">-</div>
                <div class="stat-label">Proyectos Workana</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="upworkProjects">-</div>
                <div class="stat-label">Proyectos Upwork</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="recentProjects">-</div>
                <div class="stat-label">√öltimas 24h</div>
            </div>
        </div>

        <div class="main-content">
            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error" id="errorAlert"></div>

            <!-- Filters and Search -->
            <div class="section">
                <h2 class="section-title">
                    üîç Filtros y B√∫squeda
                    <div class="section-actions">
                        <button class="btn btn-secondary btn-small" onclick="clearFilters()">
                            üóëÔ∏è Limpiar Filtros
                        </button>
                        <button class="btn btn-info btn-small" onclick="loadProjects()">
                            üîÑ Actualizar
                        </button>
                    </div>
                </h2>
                <div class="filters" id="filtersContainer">
                    <div class="filters-row">
                        <div class="filter-group">
                            <label for="searchQuery">Buscar</label>
                            <input type="text" id="searchQuery" placeholder="Buscar proyectos..." style="width: 300px;">
                        </div>
                        <div class="filter-group">
                            <label for="platformFilter">Plataforma</label>
                            <select id="platformFilter">
                                <option value="">Todas</option>
                                <option value="workana">Workana</option>
                                <option value="upwork">Upwork</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="budgetFilter">Presupuesto</label>
                            <select id="budgetFilter">
                                <option value="">Todos</option>
                                <option value="0-500">$0 - $500</option>
                                <option value="500-1000">$500 - $1,000</option>
                                <option value="1000-5000">$1,000 - $5,000</option>
                                <option value="5000+">$5,000+</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="dateFilter">Fecha</label>
                            <select id="dateFilter">
                                <option value="">Todas</option>
                                <option value="today">Hoy</option>
                                <option value="week">Esta semana</option>
                                <option value="month">Este mes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="sortBy">Ordenar por</label>
                            <select id="sortBy">
                                <option value="published_at">Fecha de publicaci√≥n</option>
                                <option value="budget">Presupuesto</option>
                                <option value="title">T√≠tulo</option>
                                <option value="platform">Plataforma</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="sortOrder">Orden</label>
                            <select id="sortOrder">
                                <option value="desc">Descendente</option>
                                <option value="asc">Ascendente</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Projects Table -->
            <div class="section">
                <h2 class="section-title">
                    üìã Proyectos
                    <div class="section-actions">
                        <button class="btn btn-success btn-small" onclick="exportProjects()">
                            üìä Exportar CSV
                        </button>
                        <button class="btn btn-primary btn-small" onclick="showScrapingModal()">
                            üîÑ Scraping Manual
                        </button>
                    </div>
                </h2>
                <div id="projectsTableContainer">
                    <div class="loading">Cargando proyectos...</div>
                </div>
                <div id="paginationContainer"></div>
            </div>
        </div>
    </div>

    <!-- Project Details Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Detalles del Proyecto</h2>
                <span class="close" onclick="closeProjectModal()">&times;</span>
            </div>
            <div class="modal-body" id="projectModalBody">
                <!-- Project details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Scraping Control Modal -->
    <div id="scrapingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîÑ Control de Scraping</h2>
                <span class="close" onclick="closeScrapingModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-container">
                    <h3>Scraping Manual</h3>
                    <p>Ejecuta el scraping de proyectos manualmente con las opciones que desees.</p>
                    
                    <div class="form-group">
                        <label for="scrapingPlatform">Plataforma</label>
                        <select id="scrapingPlatform">
                            <option value="both">Ambas plataformas</option>
                            <option value="workana">Solo Workana</option>
                            <option value="upwork">Solo Upwork</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableNotifications" checked>
                            Enviar notificaciones durante el scraping
                        </label>
                    </div>


                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="parallelMode" checked>
                            Modo paralelo (m√°s r√°pido)
                        </label>
                    </div>

                    <div class="form-row">
                        <button class="btn btn-primary" onclick="startScraping()">
                            üöÄ Iniciar Scraping
                        </button>
                        <button class="btn btn-secondary" onclick="closeScrapingModal()">
                            ‚ùå Cancelar
                        </button>
                    </div>

                    <div id="scrapingProgress" class="hidden" style="margin-top: 20px;">
                        <div class="alert alert-info">
                            <div id="scrapingStatus">Iniciando scraping...</div>
                            <div class="spinner" style="margin: 10px auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Proposal Modal -->
    <div id="sendProposalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì§ Enviar Propuesta</h2>
                <span class="close" onclick="closeSendProposalModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-container">
                    <h3 id="proposalProjectTitle">Enviar propuesta</h3>
                    <p>Selecciona un usuario para enviar la propuesta desde su cuenta.</p>
                    
                    <div class="form-group">
                        <label for="proposalUserId">Usuario</label>
                        <select id="proposalUserId" required>
                            <option value="">Selecciona un usuario...</option>
                        </select>
                        <small class="form-help">Solo se muestran usuarios activos con sesi√≥n v√°lida</small>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoLoginProposal" checked>
                            Iniciar sesi√≥n autom√°ticamente si es necesario
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="generateCustomProposal" checked>
                            Generar propuesta personalizada con IA
                        </label>
                    </div>

                    <div class="form-row">
                        <button class="btn btn-primary" onclick="sendProposal()">
                            üì§ Enviar Propuesta
                        </button>
                        <button class="btn btn-secondary" onclick="closeSendProposalModal()">
                            ‚ùå Cancelar
                        </button>
                    </div>

                    <div id="proposalProgress" class="hidden" style="margin-top: 20px;">
                        <div class="alert alert-info">
                            <div id="proposalStatus">Enviando propuesta...</div>
                            <div class="spinner" style="margin: 10px auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/components.js"></script>
    <script>
        // Global state
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};
        let projects = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadProjects();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Search input with debounce
            const searchInput = document.getElementById('searchQuery');
            searchInput.addEventListener('input', Utils.debounce((e) => {
                currentFilters.search = e.target.value;
                currentPage = 1;
                loadProjects();
            }, 300));

            // Filter selects
            const filters = ['platformFilter', 'budgetFilter', 'dateFilter', 'sortBy', 'sortOrder'];
            filters.forEach(filterId => {
                const filter = document.getElementById(filterId);
                filter.addEventListener('change', (e) => {
                    const filterKey = filterId.replace('Filter', '').replace('sortBy', 'sort').replace('sortOrder', 'order');
                    currentFilters[filterKey] = e.target.value;
                    currentPage = 1;
                    loadProjects();
                });
            });

            // Modal close handlers
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // Load project statistics
        async function loadStats() {
            try {
                const result = await api.getProjectStats();
                if (result.success) {
                    document.getElementById('totalProjects').textContent = result.data.total || 0;
                    document.getElementById('workanaProjects').textContent = result.data.workana || 0;
                    document.getElementById('upworkProjects').textContent = result.data.upwork || 0;
                    document.getElementById('recentProjects').textContent = result.data.recent24h || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load projects with pagination
        async function loadProjects() {
            try {
                const container = document.getElementById('projectsTableContainer');
                Utils.showLoading(container, 'Cargando proyectos...');

                const params = {
                    page: currentPage,
                    limit: 20,
                    ...currentFilters
                };

                const result = await api.getProjects(params);
                
                if (result.success) {
                    projects = result.data.projects;
                    totalPages = result.data.totalPages;
                    
                    renderProjectsTable();
                    renderPagination();
                    loadStats(); // Refresh stats
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                const container = document.getElementById('projectsTableContainer');
                container.innerHTML = `<div class="alert alert-error">Error cargando proyectos: ${error.message}</div>`;
            }
        }

        // Render projects table
        function renderProjectsTable() {
            const container = document.getElementById('projectsTableContainer');
            
            if (projects.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No se encontraron proyectos con los filtros aplicados</div>';
                return;
            }

            const columns = [
                { key: 'title', label: 'T√≠tulo' },
                { key: 'platform', label: 'Plataforma' },
                { key: 'budget', label: 'Presupuesto' },
                { key: 'published_at', label: 'Publicado' },
                { key: 'actions', label: 'Acciones' }
            ];

            const tableData = projects.map(project => ({
                ...project,
                title: `<div class="text-truncate" style="max-width: 300px;" title="${Utils.escapeHtml(project.title)}">${Utils.escapeHtml(project.title)}</div>`,
                platform: Utils.getPlatformBadge(project.platform),
                budget: project.price ?? 'No especificado',
                published_at: Utils.formatRelativeTime(project.createdAt),
                actions: `
                    <div class="actions">
                        <button class="btn btn-primary btn-small" onclick="viewProject(${project.id})">
                            üëÅÔ∏è Ver
                        </button>
                        <button class="btn btn-success btn-small" onclick="generateProposal(${project.id})">
                            üí° Propuesta
                        </button>
                        <button class="btn btn-info btn-small" onclick="copyProjectUrl('${project.link}')">
                            üîó Copiar URL
                        </button>
                    </div>
                `
            }));

            const table = UIComponents.createDataTable(tableData, columns);
            container.innerHTML = '';
            container.appendChild(table);
        }

        // Render pagination
        function renderPagination() {
            const container = document.getElementById('paginationContainer');
            container.innerHTML = '';
            
            if (totalPages > 1) {
                const pagination = UIComponents.createPagination(currentPage, totalPages, (page) => {
                    currentPage = page;
                    loadProjects();
                });
                container.appendChild(pagination);
            }
        }

        // View project details
        async function viewProject(projectId) {
            // Encontrar el bot√≥n que se hizo clic y mostrar loader
            const event = window.event || event;
            const button = event.target.closest('button');
            let originalText = '';
            let buttonFound = false;
            
            if (button) {
                originalText = button.innerHTML;
                buttonFound = true;
                
                // Mostrar loader en el bot√≥n
                button.innerHTML = '<div class="spinner" style="width: 12px; height: 12px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; display: block; margin: 0 auto;"></div>';
                button.disabled = true;
            }
            
            try {
                const result = await api.getProjectById(projectId);
                if (result.success) {
                    const project = result.data;
                    
                    document.getElementById('projectModalBody').innerHTML = `
                        <div class="project-details">
                            <!-- Header del proyecto -->
                            <div class="project-header">
                                <h3 class="project-title">${Utils.escapeHtml(project.title)}</h3>
                                <div class="project-meta">
                                    <span class="platform-badge platform-${project.platform}">${Utils.capitalize(project.platform)}</span>
                                    <span class="project-date">${project.timeAgo || project.date || 'Fecha no disponible'}</span>
                                </div>
                            </div>
                            
                            <!-- Informaci√≥n principal -->
                            <div class="project-main-info">
                                <div class="info-row">
                                    <div class="info-item">
                                        <span class="info-label">üí∞ Presupuesto:</span>
                                        <span class="budget-info">${Utils.escapeHtml(project.price || 'No especificado')}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">üë§ Cliente:</span>
                                        <span>${Utils.escapeHtml(project.clientName || 'No especificado')} (${Utils.escapeHtml(project.clientCountry || 'No especificado')})</span>
                                    </div>
                                </div>
                                
                                <div class="info-row">
                                    <div class="info-item">
                                        <span class="info-label">‚≠ê Calificaci√≥n:</span>
                                        <span>${project.clientRating ? `${project.clientRating}/5` : 'Sin calificaci√≥n'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">üí≥ Pago Verificado:</span>
                                        <span>${project.paymentVerified ? '‚úÖ S√≠' : '‚ùå No'}</span>
                                    </div>
                                </div>
                                
                                <div class="info-row">
                                    <div class="info-item">
                                        <span class="info-label">üè∑Ô∏è Destacado:</span>
                                        <span>${project.isFeatured ? '‚úÖ S√≠' : '‚ùå No'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">üìä M√°ximo:</span>
                                        <span>${project.isMaxProject ? '‚úÖ S√≠' : '‚ùå No'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Descripci√≥n -->
                            <div class="project-section">
                                <h4>üìù Descripci√≥n</h4>
                                <div class="description-content">
                                    ${Utils.escapeHtml(project.description || 'Sin descripci√≥n disponible')}
                                </div>
                            </div>
                            
                            <!-- Habilidades -->
                            <div class="project-section">
                                <h4>üõ†Ô∏è Habilidades</h4>
                                <div class="skills-content">
                                    ${project.skills ? project.skills.split(',').map(skill => 
                                        `<span class="skill-tag">${Utils.escapeHtml(skill.trim())}</span>`
                                    ).join('') : '<p>No especificadas</p>'}
                                </div>
                            </div>
                            
                            <!-- Informaci√≥n t√©cnica y enlaces -->
                            <div class="project-footer">
                                <div class="footer-info">
                                    <div class="info-item">
                                        <span class="info-label">ID:</span>
                                        <span>${project.id}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Detectado:</span>
                                        <span>${Utils.formatDate(project.createdAt)}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Actualizado:</span>
                                        <span>${Utils.formatDate(project.updatedAt)}</span>
                                    </div>
                                </div>
                                
                                <div class="footer-actions">
                                    <a href="${project.link}" target="_blank" rel="noopener noreferrer" class="project-link">Ver en ${Utils.capitalize(project.platform)}</a>
                                    <button class="btn btn-primary btn-small" onclick="showSendProposalModal(${project.id}, '${Utils.escapeHtml(project.title)}')">
                                        üì§ Enviar Propuesta
                                    </button>
                                    <button class="btn btn-secondary btn-small" onclick="closeProjectModal()">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('projectModal').style.display = 'block';
                } else {
                    showAlert('error', result.error);
                }
            } catch (error) {
                showAlert('error', 'Error cargando proyecto: ' + error.message);
            } finally {
                // Restaurar el bot√≥n a su estado original si se encontr√≥
                if (buttonFound && button) {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }
        }

        // Generate proposal for project
        async function generateProposal(projectId) {
            try {
                const project = projects.find(p => p.id === projectId);
                if (!project) {
                    showAlert('error', 'Proyecto no encontrado');
                    return;
                }

                const result = await api.generateProposal({
                    projectId: projectId,
                    projectTitle: project.title,
                    projectDescription: project.description,
                    platform: project.platform
                });

                if (result.success) {
                    UIComponents.createModal('üí° Propuesta Generada', `
                        <div class="proposal-content">
                            <h4>Propuesta para: ${Utils.escapeHtml(project.title)}</h4>
                            <div class="proposal-text" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">
                                ${Utils.escapeHtml(result.data.proposal)}
                            </div>
                            <button class="btn btn-success" onclick="copyProposal('${result.data.proposal.replace(/'/g, "\\'")}')">
                                üìã Copiar Propuesta
                            </button>
                        </div>
                    `);
                } else {
                    showAlert('error', result.error);
                }
            } catch (error) {
                showAlert('error', 'Error generando propuesta: ' + error.message);
            }
        }

        // Copy project URL
        async function copyProjectUrl(proyectUrl) {
            const success = await Utils.copyToClipboard(proyectUrl);
            if (success) {
                showAlert('success', 'URL del proyecto copiada al portapapeles');
            } else {
                showAlert('error', 'Error copiando URL del proyecto');
            }
        }

        // Copy proposal to clipboard
        async function copyProposal(proposal) {
            const success = await Utils.copyToClipboard(proposal);
            if (success) {
                showAlert('success', 'Propuesta copiada al portapapeles');
            } else {
                showAlert('error', 'Error copiando propuesta');
            }
        }

        // Export projects to CSV
        function exportProjects() {
            if (projects.length === 0) {
                showAlert('error', 'No hay proyectos para exportar');
                return;
            }

            const csvData = projects.map(project => ({
                'ID': project.id,
                'T√≠tulo': project.title,
                'Plataforma': project.platform,
                'Presupuesto': project.budget || '',
                'Moneda': project.currency || '',
                'Categor√≠a': project.category || '',
                'Publicado': project.published_at,
                'Detectado': project.created_at,
                'URL': project.url
            }));

            const csvContent = convertToCSV(csvData);
            const timestamp = new Date().toISOString().split('T')[0];
            Utils.downloadFile(csvContent, `proyectos_${timestamp}.csv`, 'text/csv');
            showAlert('success', 'Proyectos exportados correctamente');
        }

        // Convert data to CSV
        function convertToCSV(data) {
            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(row => 
                Object.values(row).map(value => 
                    `"${String(value).replace(/"/g, '""')}"`
                ).join(',')
            );
            return [headers, ...rows].join('\n');
        }

        // Show scraping modal
        function showScrapingModal() {
            document.getElementById('scrapingModal').style.display = 'block';
        }

        // Close scraping modal
        function closeScrapingModal() {
            document.getElementById('scrapingModal').style.display = 'none';
            document.getElementById('scrapingProgress').classList.add('hidden');
        }

        // Start scraping
        async function startScraping() {
            const platform = document.getElementById('scrapingPlatform').value;
            const notifications = document.getElementById('enableNotifications').checked;
            const parallel = document.getElementById('parallelMode').checked;

            const progressContainer = document.getElementById('scrapingProgress');
            const statusDiv = document.getElementById('scrapingStatus');
            
            progressContainer.classList.remove('hidden');
            statusDiv.textContent = 'Iniciando scraping...';

            try {
                let result;
                const options = {
                    notifications,
                    parallel
                };

                if (platform === 'both') {
                    statusDiv.textContent = 'Ejecutando scraping en ambas plataformas...';
                    result = await api.scrapeSingle(options);
                } else if (platform === 'workana') {
                    statusDiv.textContent = 'Ejecutando scraping en Workana...';
                    result = await api.scrapeWorkana(options);
                } else if (platform === 'upwork') {
                    statusDiv.textContent = 'Ejecutando scraping en Upwork...';
                    result = await api.scrapeUpwork(options);
                }

                if (result.success) {
                    statusDiv.textContent = `‚úÖ Scraping completado: ${result.data.newProjects || 0} nuevos proyectos encontrados`;
                    showAlert('success', `Scraping completado exitosamente. ${result.data.newProjects || 0} nuevos proyectos encontrados.`);
                    
                    // Refresh data
                    setTimeout(() => {
                        loadProjects();
                        loadStats();
                        closeScrapingModal();
                    }, 2000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
                showAlert('error', 'Error ejecutando scraping: ' + error.message);
            }
        }

        // Show control panel
        function showControlPanel() {
            UIComponents.createModal('‚öôÔ∏è Panel de Control', `
                <div class="control-panel">
                    <h3>Operaciones del Sistema</h3>
                    <div class="control-actions">
                        <button class="btn btn-info btn-block mb-20" onclick="checkSystemHealth()">
                            üíó Verificar Salud del Sistema
                        </button>
                        <button class="btn btn-warning btn-block mb-20" onclick="cleanupDatabase()">
                            üßπ Limpiar Base de Datos
                        </button>
                        <button class="btn btn-secondary btn-block mb-20" onclick="viewSystemStatus()">
                            üìä Estado del Sistema
                        </button>
                    </div>
                </div>
            `);
        }

        // Check system health
        async function checkSystemHealth() {
            try {
                const result = await api.getHealth();
                if (result.success) {
                    showAlert('success', 'Sistema funcionando correctamente');
                } else {
                    showAlert('error', 'Problemas detectados en el sistema');
                }
            } catch (error) {
                showAlert('error', 'Error verificando salud del sistema: ' + error.message);
            }
        }

        // Cleanup database
        async function cleanupDatabase() {
            const confirmed = await UIComponents.confirm(
                '¬øEst√° seguro de que desea limpiar la base de datos? Esta operaci√≥n eliminar√° duplicados y optimizar√° el almacenamiento.',
                'Confirmar Limpieza'
            );

            if (confirmed) {
                try {
                    const result = await api.cleanup();
                    if (result.success) {
                        showAlert('success', 'Base de datos limpiada exitosamente');
                        loadProjects();
                        loadStats();
                    } else {
                        showAlert('error', result.error);
                    }
                } catch (error) {
                    showAlert('error', 'Error limpiando base de datos: ' + error.message);
                }
            }
        }

        // View system status
        async function viewSystemStatus() {
            try {
                const result = await api.getStatus();
                if (result.success) {
                    UIComponents.createModal('üìä Estado del Sistema', `
                        <div class="system-status">
                            <h4>Informaci√≥n del Sistema</h4>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        </div>
                    `);
                } else {
                    showAlert('error', result.error);
                }
            } catch (error) {
                showAlert('error', 'Error obteniendo estado del sistema: ' + error.message);
            }
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('platformFilter').value = '';
            document.getElementById('budgetFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('sortBy').value = 'published_at';
            document.getElementById('sortOrder').value = 'desc';
            
            currentFilters = {};
            currentPage = 1;
            loadProjects();
        }

        // Close project modal
        function closeProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        // Show send proposal modal
        async function showSendProposalModal(projectId, projectTitle) {
            try {
                // Cargar usuarios activos
                const result = await api.getActiveUsers();
                if (!result.success) {
                    throw new Error(result.error);
                }

                const users = result.data.filter(user => user.isActive);
                
                if (users.length === 0) {
                    showAlert('error', 'No hay usuarios activos disponibles para enviar propuestas');
                    return;
                }

                // Actualizar el t√≠tulo del proyecto
                document.getElementById('proposalProjectTitle').textContent = `Enviar propuesta: ${projectTitle}`;
                
                // Llenar el select con usuarios
                const userSelect = document.getElementById('proposalUserId');
                userSelect.innerHTML = '<option value="">Selecciona un usuario...</option>';
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.workanaEmail} (${user.telegramUser || 'Sin Telegram'})`;
                    userSelect.appendChild(option);
                });

                // Guardar el projectId para usarlo en sendProposal
                document.getElementById('sendProposalModal').setAttribute('data-project-id', projectId);
                
                // Mostrar el modal
                document.getElementById('sendProposalModal').style.display = 'block';
                
            } catch (error) {
                showAlert('error', 'Error cargando usuarios: ' + error.message);
            }
        }

        // Close send proposal modal
        function closeSendProposalModal() {
            document.getElementById('sendProposalModal').style.display = 'none';
            document.getElementById('proposalProgress').classList.add('hidden');
        }

        // Send proposal
        async function sendProposal() {
            const projectId = document.getElementById('sendProposalModal').getAttribute('data-project-id');
            const userId = document.getElementById('proposalUserId').value;
            const autoLogin = document.getElementById('autoLoginProposal').checked;
            const generateCustom = document.getElementById('generateCustomProposal').checked;

            if (!userId) {
                showAlert('error', 'Por favor selecciona un usuario');
                return;
            }

            const progressContainer = document.getElementById('proposalProgress');
            const statusDiv = document.getElementById('proposalStatus');
            
            progressContainer.classList.remove('hidden');
            statusDiv.textContent = 'Enviando propuesta...';

            try {
                const result = await api.sendProposal(projectId, userId, {
                    autoLogin,
                    generateCustom
                });

                if (result.success) {
                    statusDiv.textContent = '‚úÖ Propuesta enviada exitosamente';
                    showAlert('success', `Propuesta enviada correctamente desde la cuenta de ${result.data.userEmail || 'usuario'}`);
                    
                    // Cerrar modal despu√©s de 2 segundos
                    setTimeout(() => {
                        closeSendProposalModal();
                        closeProjectModal(); // Tambi√©n cerrar el modal de detalles
                    }, 2000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
                showAlert('error', 'Error enviando propuesta: ' + error.message);
            }
        }

        // Logout function
        function logout() {
            if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                Utils.logout();
            }
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is authenticated
            if (!Utils.isAuthenticated()) {
                Utils.checkAuthRedirect();
                return;
            }

            // Display current user info
            const userInfo = Utils.getUserInfo();
            if (userInfo) {
                document.getElementById('currentUser').textContent = userInfo.email;
            }

            // Load page data
            loadProjects();
        });

        // Utility functions
        function showAlert(type, message) {
            const alertElement = document.getElementById(type === 'success' ? 'successAlert' : 'errorAlert');
            alertElement.textContent = message;
            alertElement.style.display = 'block';
            
            const otherAlert = document.getElementById(type === 'success' ? 'errorAlert' : 'successAlert');
            otherAlert.style.display = 'none';
            
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>